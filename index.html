<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MISS SHIBA CafÃ© Pro</title>
    <style>
        :root {
            --bg-color: #f8f4f0;
            --primary-brown: #5d4037;
            --table-free: #ffffff;
            --status-ok: #e8f5e9;
            --status-warn: #fff9c4;
            --status-urgent: #ffccbc;
            --status-over: #ef9a9a;
            --status-swap-active: #2196f3; 
        }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-color); margin: 0; overflow: hidden; touch-action: none; }
        
        /* é ‚éƒ¨è³‡è¨Šæ¬„ */
        #header { background: var(--primary-brown); color: white; padding: 10px 15px; z-index: 1000; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .stats-bar { font-size: 0.9rem; margin-top: 5px; color: #d7ccc8; border-top: 1px solid #795548; padding-top: 5px; }
        
        /* æ§åˆ¶æ¬„ */
        #controls { padding: 8px 15px; background: #efebe9; display: flex; flex-wrap: wrap; gap: 15px; align-items: center; font-size: 14px; border-bottom: 1px solid #d7ccc8; }
        
        /* ç•«å¸ƒå€åŸŸ */
        #floor-plan-container { width: 100vw; height: calc(100vh - 160px); overflow: auto; background-color: #eee; background-image: radial-gradient(#d1cfc7 1px, transparent 1px); background-size: 20px 20px; }
        #floor-plan { position: relative; width: 2000px; height: 2000px; transform-origin: 0 0; }
        
        /* æ¡Œå­æœ¬é«” */
        .table { 
            position: absolute; background: var(--table-free); 
            border: 3px solid #8d6e63; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            box-shadow: 0 6px 12px rgba(0,0,0,0.15); z-index: 10; 
            min-width: 100px; min-height: 100px; transition: transform 0.1s;
        }
        .occupied { background: var(--status-ok); border-color: #4caf50; }
        .warn { background: var(--status-warn); border-color: #fbc02d; }
        .urgent { background: var(--status-urgent); border-color: #ff5722; }
        .over { background: var(--status-over); border-color: #d32f2f; animation: pulse 1s infinite; }
        
        /* æ›æ¡Œä¸­é¸å–æ•ˆæœ */
        .swap-source { 
            outline: 6px solid var(--status-swap-active) !important; 
            outline-offset: 4px;
            animation: swap-blink 0.6s infinite;
            z-index: 100 !important;
        }
        @keyframes swap-blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* æ–‡å­—èˆ‡è¨ˆæ™‚ */
        .table-id { font-weight: bold; font-size: 1.2rem; border: none; background: transparent; text-align: center; width: 90%; color: #3e2723; pointer-events: none; margin-bottom: 2px; }
        .timer { font-family: 'Courier New', monospace; font-size: 1.3rem; font-weight: bold; margin-bottom: 8px; pointer-events: none; }
        
        /* æŒ‰éˆ•çµ„ï¼šåŠ å¤§é–“è·èˆ‡å°ºå¯¸ */
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; width: 90%; }
        button { padding: 8px 4px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-start { background: #4caf50; color: white; grid-column: span 2; font-size: 15px; padding: 10px; }
        .btn-plus { background: #ff9800; color: white; }
        .btn-swap { background: #2196f3; color: white; }
        .btn-reset { background: #757575; color: white; grid-column: span 2; margin-top: 4px; }
        
        /* ç·¨è¼¯æ¨¡å¼ */
        .resizer { position: absolute; bottom: 0; right: 0; width: 24px; height: 24px; background: #8d6e63; cursor: nwse-resize; border-radius: 0 0 10px 0; display: none; }
        .edit-mode .resizer { display: block; }
        .btn-delete { position: absolute; top: -12px; right: -12px; background: #f44336; color: white; border-radius: 50%; width: 28px; height: 28px; display: none; z-index: 100; font-size: 20px; line-height: 28px; border: 2px solid white; }
        .edit-mode .btn-delete { display: block; }
        .edit-mode .table-id { pointer-events: auto; background: rgba(255,255,255,0.7); border-bottom: 1px dashed #8d6e63; }
    </style>
</head>
<body>

<div id="header">
    <div class="header-top">
        <div style="font-size: 1.4rem; font-weight: bold;">ğŸ¶ MISS SHIBA CafÃ©</div>
        <button id="add-btn" style="background:#fff; color:var(--primary-brown); font-weight:bold; display:none; padding: 8px 15px;" onclick="createNewTable()">ï¼‹æ–°å¢æ¡Œä½</button>
    </div>
    <div class="stats-bar" id="stats-display">çµ±è¨ˆä¸­...</div>
</div>

<div id="controls">
    <label style="display:flex; align-items:center; gap:8px; font-weight:bold;">
        <input type="checkbox" id="lock-toggle" style="width:20px; height:20px;" onchange="toggleLock()"> ğŸ”§ç·¨è¼¯æ¨¡å¼
    </label>
    <div style="display:flex; align-items:center; gap:10px;">
        ğŸ” <input type="range" min="0.5" max="1.5" step="0.1" value="1" style="width:120px;" oninput="adjustZoom(this.value)">
    </div>
    <div id="swap-msg" style="color:#2196f3; font-weight:bold; display:none;">è«‹é»æ“Šç›®æ¨™æ¡Œå­...</div>
</div>

<div id="floor-plan-container">
    <div id="floor-plan"></div>
</div>

<script>
    const DEFAULT_DURATION = 90 * 60;
    let isEditMode = false;
    let zoomScale = 1;
    let swapSourceId = null;
    let tablesData = JSON.parse(localStorage.getItem('shibaTablesV7')) || [];

    window.onload = () => {
        if (tablesData.length === 0) {
            for(let i=1; i<=8; i++) createNewTable(50 + (i-1)*150, 50, `${i}`);
        } else {
            tablesData.forEach(data => renderTable(data));
        }
        setInterval(updateAllTimers, 1000);
        updateStats();
    };

    function toggleLock() {
        isEditMode = document.getElementById('lock-toggle').checked;
        document.body.classList.toggle('edit-mode', isEditMode);
        document.getElementById('add-btn').style.display = isEditMode ? 'block' : 'none';
    }

    function adjustZoom(val) {
        zoomScale = val;
        document.getElementById('floor-plan').style.transform = `scale(${val})`;
    }

    function saveToLocal() {
        const data = Array.from(document.querySelectorAll('.table')).map(t => ({
            id: t.id, name: t.querySelector('.table-id').value,
            left: t.style.left, top: t.style.top,
            width: t.style.width, height: t.style.height,
            startTime: t.dataset.startTime || null,
            extraTime: parseInt(t.dataset.extraTime) || 0,
            isOccupied: t.classList.contains('occupied')
        }));
        localStorage.setItem('shibaTablesV7', JSON.stringify(data));
        updateStats();
    }

    function createNewTable(left = 100, top = 100, name = "æ–°") {
        const data = { id: 't-' + Date.now(), name, left: left + 'px', top: top + 'px', width: '130px', height: '140px', startTime: null, extraTime: 0, isOccupied: false };
        renderTable(data);
        saveToLocal();
    }

    function renderTable(data) {
        const floor = document.getElementById('floor-plan');
        const table = document.createElement('div');
        table.className = `table ${data.isOccupied ? 'occupied' : ''}`;
        table.style.left = data.left; table.style.top = data.top;
        table.style.width = data.width; table.style.height = data.height;
        table.id = data.id;
        table.dataset.startTime = data.startTime || "";
        table.dataset.extraTime = data.extraTime || 0;

        // é»æ“Šæ•´å¼µæ¡Œå­ä¹Ÿèƒ½è§¸ç™¼æ›æ¡Œï¼Œä½†å¿…é ˆåœ¨æ›æ¡Œæ¨¡å¼å•Ÿå‹•å¾Œ
        table.onclick = (e) => {
            if (swapSourceId && e.target.className.includes('table')) {
                executeSwap(data.id);
            }
        };

        table.innerHTML = `
            <button class="btn-delete" onclick="deleteTable(event, '${data.id}')">Ã—</button>
            <input class="table-id" value="${data.name}" onchange="saveToLocal()" readonly>
            <div class="timer">--:--</div>
            <div class="btn-group">
                <button class="btn-start" onclick="startTimer(event, '${data.id}')" ${data.isOccupied ? 'disabled' : ''}>é–‹æ¡Œ</button>
                <button class="btn-plus" onclick="addTime(event, '${data.id}')">+15m</button>
                <button class="btn-swap" onclick="initiateSwap(event, '${data.id}')">æ›æ¡Œ</button>
                <button class="btn-reset" onclick="resetTable(event, '${data.id}')">çµå¸³</button>
            </div>
            <div class="resizer"></div>
        `;
        setupDraggable(table);
        floor.appendChild(table);
    }

    // ç™¼èµ·æ›æ¡Œ
    function initiateSwap(e, id) {
        e.stopPropagation();
        if (swapSourceId) {
            // å¦‚æœé»äº†ç¬¬äºŒå¼µæ¡Œå­çš„æ›æ¡Œéˆ•ï¼Œä¸€æ¨£åŸ·è¡Œå°èª¿
            if (swapSourceId !== id) executeSwap(id);
            else cancelSwap();
            return;
        }
        swapSourceId = id;
        document.getElementById(id).classList.add('swap-source');
        document.getElementById('swap-msg').style.display = 'block';
    }

    // å–æ¶ˆæ›æ¡Œ
    function cancelSwap() {
        if (swapSourceId) document.getElementById(swapSourceId).classList.remove('swap-source');
        swapSourceId = null;
        document.getElementById('swap-msg').style.display = 'none';
    }

    // åŸ·è¡Œå°èª¿
    function executeSwap(targetId) {
        const srcEl = document.getElementById(swapSourceId);
        const targetEl = document.getElementById(targetId);

        // æ•¸æ“šäº’æ›é‚è¼¯
        const tempStart = srcEl.dataset.startTime;
        const tempExtra = srcEl.dataset.extraTime;
        const tempOccupied = srcEl.classList.contains('occupied');

        // ç›®æ¨™è³‡æ–™ç§»è‡³ä¾†æº
        srcEl.dataset.startTime = targetEl.dataset.startTime;
        srcEl.dataset.extraTime = targetEl.dataset.extraTime;
        if (targetEl.classList.contains('occupied')) srcEl.classList.add('occupied'); 
        else srcEl.classList.remove('occupied', 'warn', 'urgent', 'over');
        srcEl.querySelector('.btn-start').disabled = srcEl.classList.contains('occupied');

        // ä¾†æºè³‡æ–™ç§»è‡³ç›®æ¨™
        targetEl.dataset.startTime = tempStart;
        targetEl.dataset.extraTime = tempExtra;
        if (tempOccupied) targetEl.classList.add('occupied'); 
        else targetEl.classList.remove('occupied', 'warn', 'urgent', 'over');
        targetEl.querySelector('.btn-start').disabled = targetEl.classList.contains('occupied');

        cancelSwap();
        saveToLocal();
    }

    function startTimer(e, id) {
        e.stopPropagation();
        const el = document.getElementById(id);
        el.dataset.startTime = Date.now();
        el.classList.add('occupied');
        el.querySelector('.btn-start').disabled = true;
        saveToLocal();
    }

    function addTime(e, id) {
        e.stopPropagation();
        const el = document.getElementById(id);
        if (!el.classList.contains('occupied')) return;
        el.dataset.extraTime = (parseInt(el.dataset.extraTime) || 0) + 900;
        saveToLocal();
    }

    function resetTable(e, id) {
        e.stopPropagation();
        if (!confirm("ç¢ºå®šçµå¸³ä¸¦æ¸…ç©ºï¼Ÿ")) return;
        const el = document.getElementById(id);
        el.classList.remove('occupied', 'warn', 'urgent', 'over', 'swap-source');
        el.dataset.startTime = ""; el.dataset.extraTime = 0;
        el.querySelector('.timer').innerText = "--:--";
        el.querySelector('.btn-start').disabled = false;
        if(swapSourceId === id) cancelSwap();
        saveToLocal();
    }

    function deleteTable(e, id) {
        e.stopPropagation();
        if (confirm("åˆªé™¤æ­¤æ¡Œä½ï¼Ÿ")) { document.getElementById(id).remove(); saveToLocal(); }
    }

    function updateStats() {
        const total = document.querySelectorAll('.table').length;
        const occupied = document.querySelectorAll('.table.occupied').length;
        document.getElementById('stats-display').innerText = `æ»¿å¸­: ${occupied} / ç©ºæ¡Œ: ${total - occupied}`;
    }

    function updateAllTimers() {
        document.querySelectorAll('.table.occupied').forEach(el => {
            if (el.id === swapSourceId) return; // æ›æ¡Œä¸­æš«åœé¡è‰²è·³å‹•ä»¥å…è¦–è¦ºå¹²æ“¾
            const start = parseInt(el.dataset.startTime);
            const extra = parseInt(el.dataset.extraTime) || 0;
            const timeLeft = (DEFAULT_DURATION + extra) - Math.floor((Date.now() - start) / 1000);
            const timerDisplay = el.querySelector('.timer');
            el.classList.remove('warn', 'urgent', 'over');
            if (timeLeft <= 0) {
                timerDisplay.innerText = "è¶…æ™‚"; el.classList.add('over');
            } else {
                const mins = Math.floor(timeLeft / 60); const secs = timeLeft % 60;
                timerDisplay.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft <= 300) el.classList.add('urgent');
                else if (timeLeft <= 900) el.classList.add('warn');
            }
        });
    }

    function setupDraggable(el) {
        let isDragging = false, isResizing = false;
        let startX, startY, startW, startH, offset = { x: 0, y: 0 };
        el.addEventListener('mousedown', start);
        el.addEventListener('touchstart', start, {passive: false});
        function start(e) {
            const t = e.type.includes('touch') ? e.touches[0] : e;
            if (e.target.className === 'resizer') {
                isResizing = true; startX = t.clientX; startY = t.clientY;
                startW = parseInt(el.style.width); startH = parseInt(el.style.height);
                e.preventDefault();
            } else if (isEditMode && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                isDragging = true;
                offset.x = (t.clientX / zoomScale) - el.offsetLeft;
                offset.y = (t.clientY / zoomScale) - el.offsetTop;
                el.style.zIndex = 1000;
            }
        }
        document.addEventListener('mousemove', move);
        document.addEventListener('touchmove', move, { passive: false });
        function move(e) {
            const t = e.type.includes('touch') ? e.touches[0] : e;
            if (isResizing) {
                el.style.width = startW + (t.clientX - startX) / zoomScale + 'px';
                el.style.height = startH + (t.clientY - startY) / zoomScale + 'px';
            } else if (isDragging) {
                let nx = (t.clientX / zoomScale) - offset.x;
                let ny = (t.clientY / zoomScale) - offset.y;
                el.style.left = 20 * Math.round(nx / 20) + 'px';
                el.style.top = 20 * Math.round(ny / 20) + 'px';
                e.preventDefault();
            }
        }
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);
        function end() { if (isDragging || isResizing) { isDragging = false; isResizing = false; el.style.zIndex = 10; saveToLocal(); } }
    }
</script>
</body>
</html>
