<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MISS SHIBA CafÃ© - å®Œç¾ä½ˆå±€ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f8f4f0;
            --primary-brown: #5d4037;
            --table-free: #ffffff;
            --status-ok: #e8f5e9;
            --status-warn: #fff9c4;
            --status-urgent: #ffccbc;
            --status-over: #ef9a9a;
            --table-w: 160px;
            --table-h: 180px;
            --gap: 20px;
        }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-color); margin: 0; overflow: hidden; touch-action: none; }
        #header { background: var(--primary-brown); color: white; padding: 12px 15px; z-index: 1000; position: relative; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .stats-bar { font-size: 0.9rem; margin-top: 5px; color: #d7ccc8; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 5px; }
        #controls { padding: 10px 15px; background: #efebe9; display: flex; align-items: center; gap: 20px; font-size: 14px; border-bottom: 1px solid #d7ccc8; }
        
        /* ç•«å¸ƒèˆ‡è‡ªå‹•æ’ç‰ˆå®¹å™¨ */
        #floor-plan-container { width: 100vw; height: calc(100vh - 170px); overflow: auto; background-color: #eee; }
        #floor-plan { 
            position: relative; 
            padding: var(--gap);
            display: grid;
            grid-template-columns: repeat(4, var(--table-w)); /* å›ºå®šä¸€æ’å››æ¡Œ */
            grid-gap: var(--gap);
            width: fit-content;
            transform-origin: 0 0;
        }
        
        /* æ¡Œå­æ¨£å¼ */
        .table { 
            background: var(--table-free); 
            border: 3px solid #8d6e63; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; justify-content: space-between; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); padding: 10px 0;
            width: var(--table-w); height: var(--table-h);
            position: relative; /* æ”¹ç‚ºç›¸å°å®šä½ä»¥é…åˆ Grid */
            box-sizing: border-box;
        }
        .occupied { background: var(--status-ok); border-color: #4caf50; }
        .warn { background: var(--status-warn); border-color: #fbc02d; }
        .urgent { background: var(--status-urgent); border-color: #ff5722; }
        .over { background: var(--status-over); border-color: #d32f2f; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(211,47,47,0.4); } 70% { box-shadow: 0 0 0 10px rgba(211,47,47,0); } 100% { box-shadow: 0 0 0 0px rgba(211,47,47,0); } }

        .table-id { font-weight: bold; font-size: 1.3rem; border: none; background: transparent; text-align: center; width: 90%; color: #3e2723; pointer-events: none; }
        .timer { font-family: monospace; font-size: 1.5rem; font-weight: bold; margin-bottom: 5px; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; width: 90%; }
        button { padding: 12px 2px; border-radius: 8px; border: none; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-start { background: #4caf50; color: white; grid-column: span 2; font-size: 15px; }
        .btn-start:disabled { background: #ccc; color: #666; }
        .btn-plus { background: #ff9800; color: white; }
        .btn-swap { background: #2196f3; color: white; }
        .btn-reset { background: #757575; color: white; grid-column: span 2; margin-top: 4px; }

        /* æ›æ¡Œå½ˆçª— */
        #swap-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.85); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #swap-menu {
            background: white; width: 85%; max-width: 400px; border-radius: 20px;
            padding: 25px; text-align: center;
        }
        .swap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-top: 20px; max-height: 50vh; overflow-y: auto; }
        .swap-item { padding: 15px; background: #f0f0f0; border-radius: 12px; font-size: 1.2rem; font-weight: bold; }
        .btn-cancel { margin-top: 20px; background: #eee; width: 100%; padding: 15px; border-radius: 12px; }

        /* ç·¨è¼¯æ¨¡å¼åƒ…ä¿ç•™åˆªé™¤èˆ‡æ”¹å */
        .btn-delete { position: absolute; top: -10px; right: -10px; background: #f44336; color: white; border-radius: 50%; width: 30px; height: 30px; display: none; z-index: 100; font-size: 20px; border: 2px solid white; }
        .edit-mode .btn-delete { display: block; }
        .edit-mode .table-id { pointer-events: auto; background: rgba(255,255,255,0.5); }
    </style>
</head>
<body>

<div id="header">
    <div class="header-top">
        <div style="font-size: 1.3rem; font-weight: bold;">ğŸ¶ MISS SHIBA CafÃ©</div>
        <button id="add-btn" style="background:#fff; color:var(--primary-brown); font-weight:bold; display:none;" onclick="addNewTable()">ï¼‹å¢è¨­æ¡Œä½</button>
    </div>
    <div class="stats-bar" id="stats-display">çµ±è¨ˆä¸­...</div>
</div>

<div id="controls">
    <label style="display:flex; align-items:center; gap:8px;"><input type="checkbox" id="lock-toggle" onchange="toggleLock()"> ğŸ”§é…ç½®/æ”¹åæ¨¡å¼</label>
    <div style="flex-grow:1; text-align:right;">
        ğŸ” <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="adjustZoom(this.value)">
    </div>
</div>

<div id="floor-plan-container">
    <div id="floor-plan"></div>
</div>

<div id="swap-overlay">
    <div id="swap-menu">
        <div id="swap-title" style="font-weight:bold; font-size:1.2rem;">è«‹é¸å–ç›®æ¨™æ¡Œè™Ÿ</div>
        <div class="swap-grid" id="swap-list"></div>
        <button class="btn-cancel" onclick="closeSwap()">å–æ¶ˆ</button>
    </div>
</div>

<script>
    const DEFAULT_DURATION = 90 * 60;
    let zoomScale = 1;
    let sourceId = null;
    // ä½¿ç”¨ V11 ç‰ˆæœ¬
    let tablesData = JSON.parse(localStorage.getItem('shibaTablesV11')) || [];

    window.onload = () => {
        if (tablesData.length === 0) {
            // åˆå§‹åŒ– 8 å¼µæ¡Œå­ (4x2)
            for(let i=1; i<=8; i++) {
                tablesData.push({ id: 't'+Date.now()+i, name: i.toString(), startTime: "", extraTime: 0, isOccupied: false });
            }
        }
        renderAllTables();
        setInterval(updateAllTimers, 1000);
    };

    function renderAllTables() {
        const floor = document.getElementById('floor-plan');
        floor.innerHTML = "";
        tablesData.forEach(data => {
            const table = document.createElement('div');
            table.className = `table ${data.isOccupied ? 'occupied' : ''}`;
            table.id = data.id;
            
            table.innerHTML = `
                <button class="btn-delete" onclick="deleteTable('${data.id}')">Ã—</button>
                <input class="table-id" value="${data.name}" onchange="updateName('${data.id}', this.value)" readonly>
                <div class="timer">--:--</div>
                <div class="btn-group">
                    <button class="btn-start" onclick="startTimer('${data.id}')" ${data.isOccupied ? 'disabled' : ''}>é–‹æ¡Œ</button>
                    <button class="btn-plus" onclick="addTime('${data.id}')">+15m</button>
                    <button class="btn-swap" onclick="openSwap('${data.id}')">æ›æ¡Œ</button>
                    <button class="btn-reset" onclick="resetTable('${data.id}')">çµå¸³</button>
                </div>
            `;
            floor.appendChild(table);
        });
        updateStats();
        saveToLocal();
    }

    function toggleLock() {
        const isEdit = document.getElementById('lock-toggle').checked;
        document.body.classList.toggle('edit-mode', isEdit);
        document.getElementById('add-btn').style.display = isEdit ? 'block' : 'none';
    }

    function adjustZoom(val) {
        zoomScale = val;
        document.getElementById('floor-plan').style.transform = `scale(${val})`;
    }

    function saveToLocal() {
        localStorage.setItem('shibaTablesV11', JSON.stringify(tablesData));
    }

    function addNewTable() {
        const nextNum = tablesData.length + 1;
        tablesData.push({ id: 't'+Date.now(), name: nextNum.toString(), startTime: "", extraTime: 0, isOccupied: false });
        renderAllTables();
    }

    function updateName(id, newName) {
        const table = tablesData.find(t => t.id === id);
        if(table) table.name = newName;
        saveToLocal();
    }

    function startTimer(id) {
        const table = tablesData.find(t => t.id === id);
        if(table) {
            table.startTime = Date.now();
            table.isOccupied = true;
            renderAllTables();
        }
    }

    function addTime(id) {
        const table = tablesData.find(t => t.id === id);
        if(table && table.isOccupied) {
            table.extraTime += 900;
            saveToLocal();
        }
    }

    function resetTable(id) {
        if(!confirm("ç¢ºå®šçµå¸³ï¼Ÿ")) return;
        const table = tablesData.find(t => t.id === id);
        if(table) {
            table.startTime = "";
            table.extraTime = 0;
            table.isOccupied = false;
            renderAllTables();
        }
    }

    function deleteTable(id) {
        if(!confirm("åˆªé™¤æ­¤æ¡Œï¼Ÿ")) return;
        tablesData = tablesData.filter(t => t.id !== id);
        renderAllTables();
    }

    function openSwap(id) {
        sourceId = id;
        const sourceName = tablesData.find(t => t.id === id).name;
        document.getElementById('swap-title').innerText = `å°‡ã€${sourceName}ã€‘æ›è‡³...`;
        const list = document.getElementById('swap-list');
        list.innerHTML = "";
        tablesData.forEach(t => {
            if(t.id === id) return;
            const btn = document.createElement('div');
            btn.className = 'swap-item';
            btn.innerText = t.name;
            btn.onclick = () => {
                const srcIdx = tablesData.findIndex(x => x.id === sourceId);
                const tarIdx = tablesData.findIndex(x => x.id === t.id);
                
                // åƒ…å°èª¿æ•¸æ“šéƒ¨åˆ†
                const temp = { 
                    st: tablesData[srcIdx].startTime, 
                    et: tablesData[srcIdx].extraTime, 
                    oc: tablesData[srcIdx].isOccupied 
                };
                
                tablesData[srcIdx].startTime = tablesData[tarIdx].startTime;
                tablesData[srcIdx].extraTime = tablesData[tarIdx].extraTime;
                tablesData[srcIdx].isOccupied = tablesData[tarIdx].isOccupied;
                
                tablesData[tarIdx].startTime = temp.st;
                tablesData[tarIdx].extraTime = temp.et;
                tablesData[tarIdx].isOccupied = temp.oc;
                
                closeSwap();
                renderAllTables();
            };
            list.appendChild(btn);
        });
        document.getElementById('swap-overlay').style.display = 'flex';
    }

    function closeSwap() {
        document.getElementById('swap-overlay').style.display = 'none';
        sourceId = null;
    }

    function updateStats() {
        const occupied = tablesData.filter(t => t.isOccupied).length;
        document.getElementById('stats-display').innerText = `ç›®å‰ï¼š${occupied} å¸­æ»¿åº§ / ${tablesData.length - occupied} å¸­ç©ºä½`;
    }

    function updateAllTimers() {
        tablesData.forEach(data => {
            if(!data.isOccupied) return;
            const el = document.getElementById(data.id);
            if(!el) return;
            const timeLeft = (DEFAULT_DURATION + data.extraTime) - Math.floor((Date.now() - data.startTime) / 1000);
            const timerDisplay = el.querySelector('.timer');
            
            el.classList.remove('warn', 'urgent', 'over');
            if (timeLeft <= 0) {
                timerDisplay.innerText = "è¶…æ™‚"; el.classList.add('over');
            } else {
                const mins = Math.floor(timeLeft / 60); const secs = timeLeft % 60;
                timerDisplay.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft <= 300) el.classList.add('urgent');
                else if (timeLeft <= 900) el.classList.add('warn');
            }
        });
    }
</script>
</body>
</html>
