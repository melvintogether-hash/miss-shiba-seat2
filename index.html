<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MISS SHIBA Caf√©</title>
    <style>
        :root {
            --bg-color: #f8f4f0;
            --primary-brown: #5d4037;
            --table-free: #ffffff;
            --status-ok: #e8f5e9;
            --status-warn: #fff9c4;   /* 15ÂàÜ ÈªÉËâ≤ */
            --status-urgent: #ffccbc; /* 5ÂàÜ Ê∑∫Á¥Ö */
            --status-over: #ef9a9a;   /* Ë∂ÖÊôÇ Ê∑±Á¥Ö */
        }
        body {
            font-family: -apple-system, "Segoe UI", sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            overflow: hidden;
            touch-action: none;
        }
        #header {
            background: var(--primary-brown);
            color: white;
            padding: 10px 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            z-index: 100;
            position: relative;
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .stats-bar { font-size: 0.9rem; margin-top: 5px; color: #d7ccc8; border-top: 1px solid #795548; padding-top: 5px; }
        
        #controls {
            padding: 8px 15px;
            background: #efebe9;
            display: flex;
            gap: 15px;
            align-items: center;
            font-size: 14px;
        }

        #floor-plan-container {
            width: 100vw;
            height: calc(100vh - 140px);
            overflow: auto;
            background-image: radial-gradient(#d1cfc7 1px, transparent 1px);
            background-size: 20px 20px;
        }
        #floor-plan { position: relative; width: 2000px; height: 2000px; transform-origin: 0 0; }

        .table {
            position: absolute;
            width: 130px;
            height: 130px;
            background: var(--table-free);
            border: 2px solid #8d6e63;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 10;
        }
        .table.circle { border-radius: 50%; }
        .table.is-locked { cursor: default; }
        
        /* È°èËâ≤ÁãÄÊÖã */
        .occupied { background: var(--status-ok); border-color: #4caf50; }
        .warn { background: var(--status-warn); border-color: #fbc02d; }
        .urgent { background: var(--status-urgent); border-color: #ff5722; }
        .over { background: var(--status-over); border-color: #d32f2f; animation: pulse 1s infinite; }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0px rgba(211, 47, 47, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); }
            100% { box-shadow: 0 0 0 0px rgba(211, 47, 47, 0); }
        }

        .table-id { font-weight: bold; font-size: 1.1rem; border: none; background: transparent; text-align: center; width: 70px; color: #5d4037; }
        .timer { font-family: monospace; font-size: 1.2rem; font-weight: bold; margin: 4px 0; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; }
        button { padding: 5px; border-radius: 6px; border: none; cursor: pointer; font-size: 12px; }
        .btn-start { background: #4caf50; color: white; grid-column: span 2; }
        .btn-plus { background: #ff9800; color: white; }
        .btn-reset { background: #757575; color: white; }
        .btn-delete { position: absolute; top: -8px; right: -8px; background: #ff5252; color: white; width: 24px; height: 24px; border-radius: 50%; display: none; }
        .edit-mode .btn-delete { display: block; }
        
        .toggle-container { display: flex; align-items: center; gap: 5px; }
    </style>
</head>
<body>

<div id="header">
    <div class="header-top">
        <div style="font-size: 1.3rem; font-weight: bold;">üê∂ MISS SHIBA Caf√©</div>
        <button id="add-btn" style="background:#fff; color:var(--primary-brown); font-weight:bold; padding: 5px 12px; display:none;" onclick="createNewTable()">ÔºãÊ°å‰Ωç</button>
    </div>
    <div class="stats-bar" id="stats-display">ÊªøÂ∏≠: 0 / Á©∫Ê°å: 8</div>
</div>

<div id="controls">
    <div class="toggle-container">
        <input type="checkbox" id="lock-toggle" onchange="toggleLock()"> üîßÁ∑®ËºØÊ®°Âºè
    </div>
    <div class="toggle-container">
        üîé <input type="range" id="zoom-slider" min="0.5" max="1.5" step="0.1" value="1" oninput="adjustZoom(this.value)">
    </div>
</div>

<div id="floor-plan-container">
    <div id="floor-plan"></div>
</div>

<script>
    const DEFAULT_DURATION = 90 * 60;
    let isEditMode = false;
    let zoomScale = 1;
    let tablesData = JSON.parse(localStorage.getItem('shibaTablesV3')) || [];

    window.onload = () => {
        if (tablesData.length === 0) {
            for(let i=1; i<=8; i++) createNewTable(50 + (i%3)*150, 50 + Math.floor(i/3)*150, `Ê°å ${i}`);
        } else {
            tablesData.forEach(data => renderTable(data));
        }
        setInterval(updateAllTimers, 1000);
        updateStats();
    };

    function toggleLock() {
        isEditMode = document.getElementById('lock-toggle').checked;
        document.body.classList.toggle('edit-mode', isEditMode);
        document.getElementById('add-btn').style.display = isEditMode ? 'block' : 'none';
    }

    function adjustZoom(val) {
        zoomScale = val;
        document.getElementById('floor-plan').style.transform = `scale(${val})`;
    }

    function saveToLocal() {
        const data = Array.from(document.querySelectorAll('.table')).map(t => ({
            id: t.id,
            name: t.querySelector('.table-id').value,
            left: t.style.left,
            top: t.style.top,
            startTime: t.dataset.startTime || null,
            extraTime: parseInt(t.dataset.extraTime) || 0,
            isOccupied: t.classList.contains('occupied'),
            isCircle: t.classList.contains('circle')
        }));
        localStorage.setItem('shibaTablesV3', JSON.stringify(data));
        updateStats();
    }

    function createNewTable(left = 100, top = 100, name = "Êñ∞Ê°å") {
        const data = { id: 't-' + Date.now(), name, left: left + 'px', top: top + 'px', startTime: null, extraTime: 0, isOccupied: false, isCircle: false };
        renderTable(data);
        saveToLocal();
    }

    function renderTable(data) {
        const floor = document.getElementById('floor-plan');
        const table = document.createElement('div');
        table.className = `table ${data.isOccupied ? 'occupied' : ''} ${data.isCircle ? 'circle' : ''}`;
        table.style.left = data.left;
        table.style.top = data.top;
        table.id = data.id;
        table.dataset.startTime = data.startTime || "";
        table.dataset.extraTime = data.extraTime || 0;

        table.innerHTML = `
            <button class="btn-delete" onclick="deleteTable('${data.id}')">√ó</button>
            <input class="table-id" value="${data.name}" onchange="saveToLocal()" ${!isEditMode?'readonly':''}>
            <div class="timer">--:--</div>
            <div class="btn-group">
                <button class="btn-start" onclick="startTimer('${data.id}')" ${data.isOccupied ? 'disabled' : ''}>ÈñãÊ°å</button>
                <button class="btn-plus" onclick="addTime('${data.id}')">+15</button>
                <button class="btn-reset" onclick="resetTable('${data.id}')">ÁµêÂ∏≥</button>
            </div>
        `;
        setupDraggable(table);
        floor.appendChild(table);
    }

    function startTimer(id) {
        const el = document.getElementById(id);
        el.dataset.startTime = Date.now();
        el.dataset.extraTime = 0;
        el.classList.add('occupied');
        el.querySelector('.btn-start').disabled = true;
        saveToLocal();
    }

    function addTime(id) {
        const el = document.getElementById(id);
        if (!el.classList.contains('occupied')) return;
        el.dataset.extraTime = (parseInt(el.dataset.extraTime) || 0) + 900;
        saveToLocal();
    }

    function resetTable(id) {
        if (!confirm("Á¢∫ÂÆöÁµêÂ∏≥Ôºü")) return;
        const el = document.getElementById(id);
        el.className = 'table' + (el.classList.contains('circle') ? ' circle' : '');
        el.dataset.startTime = "";
        el.dataset.extraTime = 0;
        el.querySelector('.timer').innerText = "--:--";
        el.querySelector('.btn-start').disabled = false;
        saveToLocal();
    }

    function deleteTable(id) {
        if (confirm("Âà™Èô§Ôºü")) { document.getElementById(id).remove(); saveToLocal(); }
    }

    function updateStats() {
        const total = document.querySelectorAll('.table').length;
        const occupied = document.querySelectorAll('.table.occupied').length;
        document.getElementById('stats-display').innerText = `ÊªøÂ∏≠: ${occupied} / Á©∫Ê°å: ${total - occupied}`;
    }

    function updateAllTimers() {
        document.querySelectorAll('.table.occupied').forEach(el => {
            const start = parseInt(el.dataset.startTime);
            const extra = parseInt(el.dataset.extraTime) || 0;
            const elapsed = Math.floor((Date.now() - start) / 1000);
            const timeLeft = (DEFAULT_DURATION + extra) - elapsed;

            const timerDisplay = el.querySelector('.timer');
            el.classList.remove('warn', 'urgent', 'over');

            if (timeLeft <= 0) {
                timerDisplay.innerText = "Ë∂ÖÊôÇ";
                el.classList.add('over');
            } else {
                const mins = Math.floor(timeLeft / 60);
                const secs = timeLeft % 60;
                timerDisplay.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                
                if (timeLeft <= 300) el.classList.add('urgent'); // 5ÂàÜ
                else if (timeLeft <= 900) el.classList.add('warn'); // 15ÂàÜ
            }
        });
    }

    function setupDraggable(el) {
        let isDragging = false;
        let offset = { x: 0, y: 0 };

        const start = (e) => {
            if (!isEditMode || e.target.tagName === 'BUTTON' || e.target.tagName === 'INPUT') return;
            isDragging = true;
            const t = e.type.includes('touch') ? e.touches[0] : e;
            offset.x = (t.clientX / zoomScale) - el.offsetLeft;
            offset.y = (t.clientY / zoomScale) - el.offsetTop;
            el.style.zIndex = 100;
        };

        const move = (e) => {
            if (!isDragging) return;
            const t = e.type.includes('touch') ? e.touches[0] : e;
            let nx = (t.clientX / zoomScale) - offset.x;
            let ny = (t.clientY / zoomScale) - offset.y;
            el.style.left = 20 * Math.round(nx / 20) + 'px';
            el.style.top = 20 * Math.round(ny / 20) + 'px';
        };

        const stop = () => { if (isDragging) { isDragging = false; saveToLocal(); } };

        el.addEventListener('mousedown', start);
        el.addEventListener('touchstart', start);
        document.addEventListener('mousemove', move);
        document.addEventListener('touchmove', move, { passive: false });
        document.addEventListener('mouseup', stop);
        document.addEventListener('touchend', stop);
    }
</script>

</body>
</html>
