<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MISS SHIBA Caf√© Elite</title>
    <style>
        :root {
            --bg-color: #f8f4f0;
            --primary-brown: #5d4037;
            --table-free: #ffffff;
            --status-ok: #e8f5e9;
            --status-warn: #fff9c4;
            --status-urgent: #ffccbc;
            --status-over: #ef9a9a;
        }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-color); margin: 0; overflow: hidden; touch-action: none; }
        #header { background: var(--primary-brown); color: white; padding: 10px 15px; z-index: 1000; position: relative; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .stats-bar { font-size: 0.9rem; margin-top: 5px; color: #d7ccc8; border-top: 1px solid #795548; padding-top: 5px; }
        #controls { padding: 8px 15px; background: #efebe9; display: flex; align-items: center; gap: 15px; font-size: 14px; }
        #floor-plan-container { width: 100vw; height: calc(100vh - 160px); overflow: auto; background-color: #eee; }
        #floor-plan { position: relative; width: 1500px; height: 1500px; transform-origin: 0 0; }
        
        /* Ê°åÂ≠êÊ®£ÂºèÂÑ™Âåñ */
        .table { 
            position: absolute; background: var(--table-free); 
            border: 3px solid #8d6e63; border-radius: 12px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            z-index: 10; min-width: 100px; min-height: 100px; 
        }
        .occupied { background: var(--status-ok); border-color: #4caf50; }
        .warn { background: var(--status-warn); border-color: #fbc02d; }
        .urgent { background: var(--status-urgent); border-color: #ff5722; }
        .over { background: var(--status-over); border-color: #d32f2f; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(211,47,47,0.4); } 70% { box-shadow: 0 0 0 10px rgba(211,47,47,0); } 100% { box-shadow: 0 0 0 0px rgba(211,47,47,0); } }

        .table-id { font-weight: bold; font-size: 1.2rem; border: none; background: transparent; text-align: center; width: 90%; color: #3e2723; pointer-events: none; }
        .timer { font-family: monospace; font-size: 1.3rem; font-weight: bold; margin-bottom: 5px; pointer-events: none; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; width: 90%; }
        button { padding: 8px 4px; border-radius: 6px; border: none; cursor: pointer; font-size: 13px; font-weight: bold; }
        .btn-start { background: #4caf50; color: white; grid-column: span 2; }
        .btn-plus { background: #ff9800; color: white; }
        .btn-swap { background: #2196f3; color: white; }
        .btn-reset { background: #757575; color: white; grid-column: span 2; margin-top: 3px; }

        /* ÊèõÊ°åÈÅ∏ÂñÆÂÖ®Ëû¢ÂπïÈÅÆÁΩ© */
        #swap-overlay {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.8); z-index: 9999;
            display: none; flex-direction: column; align-items: center; justify-content: center;
        }
        #swap-menu {
            background: white; width: 85%; max-width: 400px; border-radius: 20px;
            padding: 20px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .swap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .swap-item { padding: 20px; background: #f0f0f0; border-radius: 12px; font-size: 1.2rem; font-weight: bold; }
        .swap-item.active { background: #2196f3; color: white; }
        .btn-cancel { margin-top: 20px; background: #ccc; padding: 10px 30px; border-radius: 10px; }

        .resizer { position: absolute; bottom: 0; right: 0; width: 25px; height: 25px; background: #8d6e63; cursor: nwse-resize; display: none; }
        .edit-mode .resizer { display: block; }
        .btn-delete { position: absolute; top: -12px; right: -12px; background: #f44336; color: white; border-radius: 50%; width: 30px; height: 30px; display: none; z-index: 100; font-size: 20px; border: 2px solid white; }
        .edit-mode .btn-delete { display: block; }
    </style>
</head>
<body>

<div id="header">
    <div class="header-top">
        <div style="font-size: 1.3rem; font-weight: bold;">üê∂ MISS SHIBA Caf√©</div>
        <button id="add-btn" style="background:#fff; color:var(--primary-brown); font-weight:bold; display:none;" onclick="createNewTable()">ÔºãÊñ∞Â¢û</button>
    </div>
    <div class="stats-bar" id="stats-display">Áµ±Ë®à‰∏≠...</div>
</div>

<div id="controls">
    <label><input type="checkbox" id="lock-toggle" onchange="toggleLock()"> üîßÁ∑®ËºØÊ®°Âºè</label>
    üîé <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="adjustZoom(this.value)">
</div>

<div id="floor-plan-container">
    <div id="floor-plan"></div>
</div>

<div id="swap-overlay">
    <div id="swap-menu">
        <h2 id="swap-title">ÊèõÊ°åÔºöÂæû Ê°å1 ÊèõÂà∞...</h2>
        <div class="swap-grid" id="swap-list"></div>
        <button class="btn-cancel" onclick="closeSwap()">ÂèñÊ∂à</button>
    </div>
</div>

<script>
    const DEFAULT_DURATION = 90 * 60;
    let isEditMode = false;
    let zoomScale = 1;
    let sourceTableId = null;
    let tablesData = JSON.parse(localStorage.getItem('shibaTablesV8')) || [];

    window.onload = () => {
        if (tablesData.length === 0) {
            for(let i=1; i<=8; i++) createNewTable(50 + (i-1)*130, 50, `${i}`);
        } else {
            tablesData.forEach(data => renderTable(data));
        }
        setInterval(updateAllTimers, 1000);
        updateStats();
    };

    function toggleLock() {
        isEditMode = document.getElementById('lock-toggle').checked;
        document.body.classList.toggle('edit-mode', isEditMode);
        document.getElementById('add-btn').style.display = isEditMode ? 'block' : 'none';
    }

    function adjustZoom(val) {
        zoomScale = val;
        document.getElementById('floor-plan').style.transform = `scale(${val})`;
    }

    function saveToLocal() {
        const data = Array.from(document.querySelectorAll('.table')).map(t => ({
            id: t.id, name: t.querySelector('.table-id').value,
            left: t.style.left, top: t.style.top,
            width: t.style.width, height: t.style.height,
            startTime: t.dataset.startTime || null,
            extraTime: parseInt(t.dataset.extraTime) || 0,
            isOccupied: t.classList.contains('occupied')
        }));
        localStorage.setItem('shibaTablesV8', JSON.stringify(data));
        updateStats();
    }

    function createNewTable(left = 100, top = 100, name = "Êñ∞") {
        const data = { id: 't-' + Date.now(), name, left: left + 'px', top: top + 'px', width: '120px', height: '140px', startTime: null, extraTime: 0, isOccupied: false };
        renderTable(data);
        saveToLocal();
    }

    function renderTable(data) {
        const floor = document.getElementById('floor-plan');
        const table = document.createElement('div');
        table.className = `table ${data.isOccupied ? 'occupied' : ''}`;
        table.style.left = data.left; table.style.top = data.top;
        table.style.width = data.width; table.style.height = data.height;
        table.id = data.id;
        table.dataset.startTime = data.startTime || "";
        table.dataset.extraTime = data.extraTime || 0;

        table.innerHTML = `
            <button class="btn-delete" onclick="deleteTable('${data.id}')">√ó</button>
            <input class="table-id" value="${data.name}" readonly>
            <div class="timer">--:--</div>
            <div class="btn-group">
                <button class="btn-start" onclick="startTimer('${data.id}')" ${data.isOccupied ? 'disabled' : ''}>ÈñãÊ°å</button>
                <button class="btn-plus" onclick="addTime('${data.id}')">+15m</button>
                <button class="btn-swap" onclick="openSwap('${data.id}')">ÊèõÊ°å</button>
                <button class="btn-reset" onclick="resetTable('${data.id}')">ÁµêÂ∏≥</button>
            </div>
            <div class="resizer"></div>
        `;
        setupDraggable(table);
        floor.appendChild(table);
    }

    // ÊâìÈñãÊèõÊ°åÈÅ∏ÂñÆ
    function openSwap(id) {
        sourceTableId = id;
        const sourceName = document.getElementById(id).querySelector('.table-id').value;
        document.getElementById('swap-title').innerText = `ÊèõÊ°åÔºöÂæû„Äê${sourceName}„ÄëÊèõÂà∞...`;
        
        const list = document.getElementById('swap-list');
        list.innerHTML = "";
        
        document.querySelectorAll('.table').forEach(t => {
            if (t.id === id) return;
            const name = t.querySelector('.table-id').value;
            const btn = document.createElement('div');
            btn.className = 'swap-item';
            btn.innerText = name;
            btn.onclick = () => executeSwap(t.id);
            list.appendChild(btn);
        });

        document.getElementById('swap-overlay').style.display = 'flex';
    }

    function closeSwap() {
        document.getElementById('swap-overlay').style.display = 'none';
        sourceTableId = null;
    }

    function executeSwap(targetId) {
        const srcEl = document.getElementById(sourceTableId);
        const targetEl = document.getElementById(targetId);

        const tempStart = srcEl.dataset.startTime;
        const tempExtra = srcEl.dataset.extraTime;
        const tempOccupied = srcEl.classList.contains('occupied');

        // Swap Êï∏Êìö
        srcEl.dataset.startTime = targetEl.dataset.startTime;
        srcEl.dataset.extraTime = targetEl.dataset.extraTime;
        if (targetEl.classList.contains('occupied')) srcEl.classList.add('occupied'); else srcEl.classList.remove('occupied', 'warn', 'urgent', 'over');
        srcEl.querySelector('.btn-start').disabled = srcEl.classList.contains('occupied');

        targetEl.dataset.startTime = tempStart;
        targetEl.dataset.extraTime = tempExtra;
        if (tempOccupied) targetEl.classList.add('occupied'); else targetEl.classList.remove('occupied', 'warn', 'urgent', 'over');
        targetEl.querySelector('.btn-start').disabled = targetEl.classList.contains('occupied');

        closeSwap();
        saveToLocal();
    }

    function startTimer(id) {
        const el = document.getElementById(id);
        el.dataset.startTime = Date.now();
        el.classList.add('occupied');
        el.querySelector('.btn-start').disabled = true;
        saveToLocal();
    }

    function addTime(id) {
        const el = document.getElementById(id);
        if (!el.classList.contains('occupied')) return;
        el.dataset.extraTime = (parseInt(el.dataset.extraTime) || 0) + 900;
        saveToLocal();
    }

    function resetTable(id) {
        if (!confirm("Á¢∫ÂÆöÁµêÂ∏≥Ôºü")) return;
        const el = document.getElementById(id);
        el.classList.remove('occupied', 'warn', 'urgent', 'over');
        el.dataset.startTime = ""; el.dataset.extraTime = 0;
        el.querySelector('.timer').innerText = "--:--";
        el.querySelector('.btn-start').disabled = false;
        saveToLocal();
    }

    function deleteTable(id) {
        if (confirm("Âà™Èô§Ê≠§Ê°å‰ΩçÔºü")) { document.getElementById(id).remove(); saveToLocal(); }
    }

    function updateStats() {
        const total = document.querySelectorAll('.table').length;
        const occupied = document.querySelectorAll('.table.occupied').length;
        document.getElementById('stats-display').innerText = `ÊªøÂ∏≠: ${occupied} / Á©∫Ê°å: ${total - occupied}`;
    }

    function updateAllTimers() {
        document.querySelectorAll('.table.occupied').forEach(el => {
            const start = parseInt(el.dataset.startTime);
            const extra = parseInt(el.dataset.extraTime) || 0;
            const timeLeft = (DEFAULT_DURATION + extra) - Math.floor((Date.now() - start) / 1000);
            const timerDisplay = el.querySelector('.timer');
            el.classList.remove('warn', 'urgent', 'over');
            if (timeLeft <= 0) {
                timerDisplay.innerText = "Ë∂ÖÊôÇ"; el.classList.add('over');
            } else {
                const mins = Math.floor(timeLeft / 60); const secs = timeLeft % 60;
                timerDisplay.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft <= 300) el.classList.add('urgent');
                else if (timeLeft <= 900) el.classList.add('warn');
            }
        });
    }

    function setupDraggable(el) {
        let isDragging = false, isResizing = false;
        let startX, startY, startW, startH, offset = { x: 0, y: 0 };
        const start = (e) => {
            const t = e.type.includes('touch') ? e.touches[0] : e;
            if (e.target.className === 'resizer') {
                isResizing = true; startX = t.clientX; startY = t.clientY;
                startW = parseInt(el.style.width); startH = parseInt(el.style.height);
                e.preventDefault();
            } else if (isEditMode && e.target.tagName !== 'BUTTON') {
                isDragging = true;
                offset.x = (t.clientX / zoomScale) - el.offsetLeft;
                offset.y = (t.clientY / zoomScale) - el.offsetTop;
                el.style.zIndex = 100;
            }
        };
        const move = (e) => {
            const t = e.type.includes('touch') ? e.touches[0] : e;
            if (isResizing) {
                el.style.width = startW + (t.clientX - startX) / zoomScale + 'px';
                el.style.height = startH + (t.clientY - startY) / zoomScale + 'px';
            } else if (isDragging) {
                el.style.left = 20 * Math.round(((t.clientX/zoomScale)-offset.x)/20) + 'px';
                el.style.top = 20 * Math.round(((t.clientY/zoomScale)-offset.y)/20) + 'px';
                e.preventDefault();
            }
        };
        const end = () => { if (isDragging || isResizing) { isDragging = false; isResizing = false; saveToLocal(); } };
        el.addEventListener('mousedown', start); el.addEventListener('touchstart', start, {passive: false});
        document.addEventListener('mousemove', move); document.addEventListener('touchmove', move, { passive: false });
        document.addEventListener('mouseup', end); document.addEventListener('touchend', end);
    }
</script>
</body>
</html>
