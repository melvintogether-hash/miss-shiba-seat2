<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>MISS SHIBA Caf√©</title>
    <style>
        :root {
            --bg-color: #f8f4f0;
            --primary-brown: #5d4037;
            --table-free: #ffffff;
            --status-ok: #e8f5e9;
            --status-warn: #fff9c4;
            --status-urgent: #ffccbc;
            --status-over: #ef9a9a;
            --status-swap: #2196f3; 
        }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg-color); margin: 0; overflow: hidden; touch-action: none; }
        #header { background: var(--primary-brown); color: white; padding: 10px 15px; z-index: 100; position: relative; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .stats-bar { font-size: 0.9rem; margin-top: 5px; color: #d7ccc8; border-top: 1px solid #795548; padding-top: 5px; }
        #controls { padding: 8px 15px; background: #efebe9; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; font-size: 13px; }
        #floor-plan-container { width: 100vw; height: calc(100vh - 160px); overflow: auto; background-image: radial-gradient(#d1cfc7 1px, transparent 1px); background-size: 20px 20px; }
        #floor-plan { position: relative; width: 2000px; height: 2000px; transform-origin: 0 0; }
        
        .table { position: absolute; background: var(--table-free); border: 2px solid #8d6e63; border-radius: 8px; display: flex; flex-direction: column; align-items: center; justify-content: center; box-shadow: 0 4px 6px rgba(0,0,0,0.1); z-index: 10; min-width: 80px; min-height: 80px; }
        .occupied { background: var(--status-ok); border-color: #4caf50; }
        .warn { background: var(--status-warn); border-color: #fbc02d; }
        .urgent { background: var(--status-urgent); border-color: #ff5722; }
        .over { background: var(--status-over); border-color: #d32f2f; animation: pulse 1s infinite; }
        
        /* ÈÅ∏‰∏≠ÊèõÊ°åÊôÇÁöÑÂãïÁï´ */
        .swap-pending { 
            outline: 4px solid var(--status-swap) !important; 
            outline-offset: 2px;
            animation: swap-blink 0.8s infinite;
            z-index: 50 !important;
        }
        @keyframes swap-blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        @keyframes pulse { 0% { box-shadow: 0 0 0 0px rgba(211, 47, 47, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(211, 47, 47, 0); } 100% { box-shadow: 0 0 0 0px rgba(211, 47, 47, 0); } }
        
        .table-id { font-weight: bold; font-size: 1rem; border: none; background: transparent; text-align: center; width: 80%; color: #5d4037; pointer-events: none; }
        .edit-mode .table-id { pointer-events: auto; background: rgba(255,255,255,0.5); }
        .timer { font-family: monospace; font-size: 1.1rem; font-weight: bold; margin: 2px 0; pointer-events: none; }
        
        .btn-group { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 3px; width: 92%; }
        button { padding: 5px; border-radius: 4px; border: none; cursor: pointer; font-size: 11px; }
        .btn-start { background: #4caf50; color: white; grid-column: span 3; margin-bottom: 2px; }
        .btn-plus { background: #ff9800; color: white; }
        .btn-swap { background: #2196f3; color: white; font-weight: bold; border: 1px solid rgba(0,0,0,0.1); }
        .btn-reset { background: #757575; color: white; }
        
        .resizer { position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; background: #8d6e63; cursor: nwse-resize; display: none; }
        .edit-mode .resizer { display: block; }
        .btn-delete { position: absolute; top: -10px; right: -10px; background: #ff5252; color: white; border-radius: 50%; width: 20px; height: 20px; display: none; z-index: 20; }
        .edit-mode .btn-delete { display: block; }
    </style>
</head>
<body>

<div id="header">
    <div class="header-top">
        <div style="font-size: 1.2rem; font-weight: bold;">üê∂ MISS SHIBA Caf√©</div>
        <button id="add-btn" style="background:#fff; color:var(--primary-brown); font-weight:bold; display:none;" onclick="createNewTable()">ÔºãÊ°å‰Ωç</button>
    </div>
    <div class="stats-bar" id="stats-display">Áµ±Ë®à‰∏≠...</div>
</div>

<div id="controls">
    <label><input type="checkbox" id="lock-toggle" onchange="toggleLock()"> üîßÁ∑®ËºØÊ®°Âºè</label>
    <span>üîé <input type="range" min="0.5" max="1.5" step="0.1" value="1" oninput="adjustZoom(this.value)"></span>
</div>

<div id="floor-plan-container">
    <div id="floor-plan"></div>
</div>

<script>
    const DEFAULT_DURATION = 90 * 60;
    let isEditMode = false;
    let zoomScale = 1;
    let swapSourceId = null;
    let tablesData = JSON.parse(localStorage.getItem('shibaTablesV6')) || [];

    window.onload = () => {
        if (tablesData.length === 0) {
            for(let i=1; i<=8; i++) createNewTable(30 + (i-1)*130, 50, `${i}`);
        } else {
            tablesData.forEach(data => renderTable(data));
        }
        setInterval(updateAllTimers, 1000);
        updateStats();
    };

    function toggleLock() {
        isEditMode = document.getElementById('lock-toggle').checked;
        document.body.classList.toggle('edit-mode', isEditMode);
        document.getElementById('add-btn').style.display = isEditMode ? 'block' : 'none';
    }

    function adjustZoom(val) {
        zoomScale = val;
        document.getElementById('floor-plan').style.transform = `scale(${val})`;
    }

    function saveToLocal() {
        const data = Array.from(document.querySelectorAll('.table')).map(t => ({
            id: t.id, name: t.querySelector('.table-id').value,
            left: t.style.left, top: t.style.top,
            width: t.style.width, height: t.style.height,
            startTime: t.dataset.startTime || null,
            extraTime: parseInt(t.dataset.extraTime) || 0,
            isOccupied: t.classList.contains('occupied')
        }));
        localStorage.setItem('shibaTablesV6', JSON.stringify(data));
        updateStats();
    }

    function createNewTable(left = 100, top = 100, name = "Êñ∞") {
        const data = { id: 't-' + Date.now(), name, left: left + 'px', top: top + 'px', width: '120px', height: '120px', startTime: null, extraTime: 0, isOccupied: false };
        renderTable(data);
        saveToLocal();
    }

    function renderTable(data) {
        const floor = document.getElementById('floor-plan');
        const table = document.createElement('div');
        table.className = `table ${data.isOccupied ? 'occupied' : ''}`;
        table.style.left = data.left; table.style.top = data.top;
        table.style.width = data.width; table.style.height = data.height;
        table.id = data.id;
        table.dataset.startTime = data.startTime || "";
        table.dataset.extraTime = data.extraTime || 0;

        table.innerHTML = `
            <button class="btn-delete" onclick="deleteTable('${data.id}')">√ó</button>
            <input class="table-id" value="${data.name}" onchange="saveToLocal()" readonly>
            <div class="timer">--:--</div>
            <div class="btn-group">
                <button class="btn-start" onclick="startTimer('${data.id}')" ${data.isOccupied ? 'disabled' : ''}>ÈñãÊ°å</button>
                <button class="btn-plus" onclick="addTime('${data.id}')">+15</button>
                <button class="btn-swap" onclick="handleSwap(event, '${data.id}')">ÊèõÊ°å</button>
                <button class="btn-reset" onclick="resetTable('${data.id}')">ÁµêÂ∏≥</button>
            </div>
            <div class="resizer"></div>
        `;
        setupDraggable(table);
        floor.appendChild(table);
    }

    function handleSwap(e, id) {
        e.stopPropagation(); // Èò≤Ê≠¢ÈªûÊìäÊåâÈàïËß∏ÁôºÊ°åÂ≠êÊãñÊãΩ
        const targetEl = document.getElementById(id);

        if (!swapSourceId) {
            // Á¨¨‰∏ÄÈöéÊÆµÔºöÈÅ∏‰∏≠‰æÜÊ∫ê
            swapSourceId = id;
            targetEl.classList.add('swap-pending');
        } else if (swapSourceId === id) {
            // ÂèñÊ∂àÈÅ∏‰∏≠
            targetEl.classList.remove('swap-pending');
            swapSourceId = null;
        } else {
            // Á¨¨‰∫åÈöéÊÆµÔºöÂü∑Ë°åÂ∞çË™ø
            const srcEl = document.getElementById(swapSourceId);
            
            // ‰∫íÊèõÊï∏Êìö
            const tempStart = srcEl.dataset.startTime;
            const tempExtra = srcEl.dataset.extraTime;
            const tempOccupied = srcEl.classList.contains('occupied');

            // Â∞áÁõÆÊ®ôÊ°åÁöÑË≥áÊñôÁµ¶‰æÜÊ∫êÊ°å
            srcEl.dataset.startTime = targetEl.dataset.startTime;
            srcEl.dataset.extraTime = targetEl.dataset.extraTime;
            if (targetEl.classList.contains('occupied')) {
                srcEl.classList.add('occupied');
            } else {
                srcEl.classList.remove('occupied', 'warn', 'urgent', 'over');
            }
            srcEl.querySelector('.btn-start').disabled = srcEl.classList.contains('occupied');

            // Â∞á‰æÜÊ∫êÊ°åË≥áÊñôÁµ¶ÁõÆÊ®ôÊ°å
            targetEl.dataset.startTime = tempStart;
            targetEl.dataset.extraTime = tempExtra;
            if (tempOccupied) {
                targetEl.classList.add('occupied');
            } else {
                targetEl.classList.remove('occupied', 'warn', 'urgent', 'over');
            }
            targetEl.querySelector('.btn-start').disabled = targetEl.classList.contains('occupied');

            // ÈáçÁΩÆÁãÄÊÖã
            srcEl.classList.remove('swap-pending');
            swapSourceId = null;
            saveToLocal();
            alert("ÊèõÊ°åÊàêÂäüÔºÅ");
        }
    }

    function startTimer(id) {
        const el = document.getElementById(id);
        el.dataset.startTime = Date.now();
        el.classList.add('occupied');
        el.querySelector('.btn-start').disabled = true;
        saveToLocal();
    }

    function addTime(id) {
        const el = document.getElementById(id);
        if (!el.classList.contains('occupied')) return;
        el.dataset.extraTime = (parseInt(el.dataset.extraTime) || 0) + 900;
        saveToLocal();
    }

    function resetTable(id) {
        if (!confirm("Á¢∫ÂÆöÁµêÂ∏≥Ôºü")) return;
        const el = document.getElementById(id);
        el.classList.remove('occupied', 'warn', 'urgent', 'over', 'swap-pending');
        el.dataset.startTime = ""; el.dataset.extraTime = 0;
        el.querySelector('.timer').innerText = "--:--";
        el.querySelector('.btn-start').disabled = false;
        if(swapSourceId === id) swapSourceId = null;
        saveToLocal();
    }

    function deleteTable(id) {
        if (confirm("Âà™Èô§Ê≠§Ê°å‰ΩçÔºü")) { document.getElementById(id).remove(); saveToLocal(); }
    }

    function updateStats() {
        const total = document.querySelectorAll('.table').length;
        const occupied = document.querySelectorAll('.table.occupied').length;
        document.getElementById('stats-display').innerText = `ÊªøÂ∏≠: ${occupied} / Á©∫Ê°å: ${total - occupied}`;
    }

    function updateAllTimers() {
        document.querySelectorAll('.table.occupied').forEach(el => {
            const start = parseInt(el.dataset.startTime);
            const extra = parseInt(el.dataset.extraTime) || 0;
            const timeLeft = (DEFAULT_DURATION + extra) - Math.floor((Date.now() - start) / 1000);
            const timerDisplay = el.querySelector('.timer');
            
            // Âè™ÊúâÊ≠£Âú®ÊèõÊ°åÁöÑÈÇ£ÂºµÊ°åÂ≠ê‰∏çË¶ÅÈ†ªÁπÅÈñÉÁàçÔºå‰øùÊåÅËóçËâ≤
            if (el.id === swapSourceId) return;

            el.classList.remove('warn', 'urgent', 'over');
            if (timeLeft <= 0) {
                timerDisplay.innerText = "Ë∂ÖÊôÇ"; el.classList.add('over');
            } else {
                const mins = Math.floor(timeLeft / 60); const secs = timeLeft % 60;
                timerDisplay.innerText = `${mins}:${secs.toString().padStart(2, '0')}`;
                if (timeLeft <= 300) el.classList.add('urgent');
                else if (timeLeft <= 900) el.classList.add('warn');
            }
        });
    }

    function setupDraggable(el) {
        let isDragging = false, isResizing = false;
        let startX, startY, startW, startH, offset = { x: 0, y: 0 };
        el.addEventListener('mousedown', start);
        el.addEventListener('touchstart', start);
        function start(e) {
            const t = e.type.includes('touch') ? e.touches[0] : e;
            if (e.target.className === 'resizer') {
                isResizing = true; startX = t.clientX; startY = t.clientY;
                startW = parseInt(el.style.width); startH = parseInt(el.style.height);
                e.preventDefault();
            } else if (isEditMode && e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                isDragging = true;
                offset.x = (t.clientX / zoomScale) - el.offsetLeft;
                offset.y = (t.clientY / zoomScale) - el.offsetTop;
                el.style.zIndex = 100;
            }
        }
        document.addEventListener('mousemove', move);
        document.addEventListener('touchmove', move, { passive: false });
        function move(e) {
            const t = e.type.includes('touch') ? e.touches[0] : e;
            if (isResizing) {
                el.style.width = startW + (t.clientX - startX) / zoomScale + 'px';
                el.style.height = startH + (t.clientY - startY) / zoomScale + 'px';
            } else if (isDragging) {
                let nx = (t.clientX / zoomScale) - offset.x;
                let ny = (t.clientY / zoomScale) - offset.y;
                el.style.left = 20 * Math.round(nx / 20) + 'px';
                el.style.top = 20 * Math.round(ny / 20) + 'px';
            }
        }
        document.addEventListener('mouseup', end);
        document.addEventListener('touchend', end);
        function end() { if (isDragging || isResizing) { isDragging = false; isResizing = false; saveToLocal(); } }
    }
</script>
</body>
</html>
